<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UIGF40ToSRGF</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/dayjs/1.11.11/dayjs.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <div class="container">
    <p>将 UIGF v4.0 标准的崩坏：星穹铁道跃迁记录数据文件转换为 SRGF v1.0 标准</p>
    <div>
      <label for="input">请选择要转换的文件：</label>
      <input id="input" type="file" accept=".json" />
    </div>
    <div>
      <button id="submit">转换</button>
    </div>
  </div>
  <script>
    const DICT = [{"category":"character","category_name":"角色","entries":{"三月七":[["1001","1224"],4],"丹恒":["1002",4],"姬子":["1003",5],"瓦尔特":["1004",5],"卡芙卡":["1005",5],"银狼":["1006",5],"阿兰":["1008",4],"艾丝妲":["1009",4],"黑塔":["1013",4],"布洛妮娅":["1101",5],"希儿":["1102",5],"希露瓦":["1103",4],"杰帕德":["1104",5],"娜塔莎":["1105",4],"佩拉":["1106",4],"克拉拉":["1107",5],"桑博":["1108",4],"虎克":["1109",4],"玲可":["1110",4],"卢卡":["1111",4],"托帕&账账":["1112",5],"青雀":["1201",4],"停云":["1202",4],"罗刹":["1203",5],"景元":["1204",5],"刃":["1205",5],"素裳":["1206",4],"驭空":["1207",4],"符玄":["1208",5],"彦卿":["1209",5],"桂乃芬":["1210",4],"白露":["1211",5],"镜流":["1212",5],"丹恒•饮月":["1213",5],"雪衣":["1214",4],"寒鸦":["1215",4],"藿藿":["1217",5],"椒丘":["1218",5],"飞霄":["1220",5],"云璃":["1221",5],"灵砂":["1222",5],"貊泽":["1223",4],"忘归人":["1225",5],"加拉赫":["1301",4],"银枝":["1302",5],"阮•梅":["1303",5],"砂金":["1304",5],"真理医生":["1305",5],"花火":["1306",5],"黑天鹅":["1307",5],"黄泉":["1308",5],"知更鸟":["1309",5],"流萤":["1310",5],"米沙":["1312",4],"星期日":["1313",5],"翡翠":["1314",5],"波提欧":["1315",5],"乱破":["1317",5],"大黑塔":["1401",5],"阿格莱雅":["1402",5],"{NICKNAME}":[["8001","8002","8003","8004","8005","8006","8007","8008"],5]}},{"category":"weapon","category_name":"光锥","entries":{"锋镝":["20000",3],"物穰":["20001",3],"天倾":["20002",3],"琥珀":["20003",3],"幽邃":["20004",3],"齐颂":["20005",3],"智库":["20006",3],"离弦":["20007",3],"嘉果":["20008",3],"乐圮":["20009",3],"戍御":["20010",3],"渊环":["20011",3],"轮契":["20012",3],"灵钥":["20013",3],"相抗":["20014",3],"蕃息":["20015",3],"俱殁":["20016",3],"开疆":["20017",3],"匿影":["20018",3],"调和":["20019",3],"睿见":["20020",3],"焚影":["20021",3],"溯忆":["20022",3],"一场术后对话":["21000",4],"晚安与睡颜":["21001",4],"余生的第一天":["21002",4],"唯有沉默":["21003",4],"记忆中的模样":["21004",4],"鼹鼠党欢迎你":["21005",4],"「我」的诞生":["21006",4],"同一种心情":["21007",4],"猎物的视线":["21008",4],"朗道的选择":["21009",4],"论剑":["21010",4],"与行星相会":["21011",4],"秘密誓心":["21012",4],"别让世界静下来":["21013",4],"此时恰好":["21014",4],"决心如汗珠般闪耀":["21015",4],"宇宙市场趋势":["21016",4],"点个关注吧！":["21017",4],"舞！舞！舞！":["21018",4],"在蓝天下":["21019",4],"天才们的休憩":["21020",4],"等价交换":["21021",4],"延长记号":["21022",4],"我们是地火":["21023",4],"春水初生":["21024",4],"过往未来":["21025",4],"汪！散步时间！":["21026",4],"早餐的仪式感":["21027",4],"暖夜不会漫长":["21028",4],"后会有期":["21029",4],"这就是我啦！":["21030",4],"重返幽冥":["21031",4],"镂月裁云之意":["21032",4],"无处可逃":["21033",4],"今日亦是和平的一日":["21034",4],"何物为真":["21035",4],"美梦小镇大冒险":["21036",4],"最后的赢家":["21037",4],"在火的远处":["21038",4],"织造命运之线":["21039",4],"银河沦陷日":["21040",4],"好戏开演":["21041",4],"铭记于心的约定":["21042",4],"两个人的演唱会":["21043",4],"无边曼舞":["21044",4],"谐乐静默之后":["21045",4],"芳华待灼":["21046",4],"黑夜如影随行":["21047",4],"梦的蒙太奇":["21048",4],"胜利只在朝夕间":["21050",4],"天才们的问候":["21051",4],"多流汗，少流泪":["21052",4],"新手任务开始前":["22000",4],"嘿，我在这儿":["22001",4],"为了明日的旅途":["22002",4],"忍事录•音律狩猎":["22003",4],"银河铁道之夜":["23000",5],"于夜色中":["23001",5],"无可取代的东西":["23002",5],"但战斗还未结束":["23003",5],"以世界之名":["23004",5],"制胜的瞬间":["23005",5],"只需等待":["23006",5],"雨一直下":["23007",5],"棺的回响":["23008",5],"到不了的彼岸":["23009",5],"拂晓之前":["23010",5],"她已闭上双眼":["23011",5],"如泥酣眠":["23012",5],"时节不居":["23013",5],"此身为剑":["23014",5],"比阳光更明亮的":["23015",5],"烦恼着，幸福着":["23016",5],"惊魂夜":["23017",5],"片刻，留在眼底":["23018",5],"镜中故我":["23019",5],"纯粹思维的洗礼":["23020",5],"游戏尘寰":["23021",5],"重塑时光之忆":["23022",5],"命运从未公平":["23023",5],"行于流逝的岸":["23024",5],"梦应归于何处":["23025",5],"夜色流光溢彩":["23026",5],"驶向第二次生命":["23027",5],"偏偏希望无价":["23028",5],"那无数个春天":["23029",5],"落日时起舞":["23030",5],"我将，巡征追猎":["23031",5],"唯有香如故":["23032",5],"忍法帖•缭乱破魔":["23033",5],"回到大地的飞行":["23034",5],"长路终有归途":["23035",5],"将光阴织成黄金":["23036",5],"向着不可追问处":["23037",5],"记一位星神的陨落":["24000",5],"星海巡航":["24001",5],"记忆的质料":["24002",5],"孤独的疗愈":["24003",5],"不息的演算":["24004",5]}}]
    .reduce((acc, curr) => {
      for (const key in curr.entries) {
        const val = curr.entries[key];
        const id = val[0];
        const ids = Array.isArray(id) ? id : [id];
        for (const id of ids) {
          acc[id] = {
            name: key,
            item_type: curr.category_name,
            rank_type: String(val[1])
          };
        }
      }
      return acc;
    }, {});

    $('#submit').on('click', function (evt) {
      const files = $('#input').get(0).files;
      if (!files || !files.length) return;

      const btn = $(this).text('转换中...').attr('disabled', true);
      const reader = new FileReader();
      reader.readAsText(files[0]);
      reader.onload = function (evt) {
        try {
          convert(evt);
        } catch (e) {
          alert(`转换失败，请检查文件格式数据是否正确！\n\n${e.message || String(e)}`);
        } finally {
          btn.text('转换').removeAttr('disabled');
        }
      };
    });

    function convert (evt) {
      const dirty = evt.target.result;
      const rawData = JSON.parse(dirty);

      const version = rawData.info.version;
      if (version !== 'v4.0') {
        throw new Error(`文件版本不匹配（预期：v4.0，实际：${version}）`);
      }

      const hkrpg = rawData.hkrpg;
      if (!hkrpg || !Array.isArray(hkrpg) || hkrpg.length === 0) {
        throw new Error(`文件数据的 'hkrpg' 字段无效或空数组：${typeof hkrpg}`);
      }

      for (const account of hkrpg) {
        const uid = account.uid;
        const now = new Date();
        const uigf = {
          info: {
            uid,
            lang: 'zh-cn',
            export_time: dayjs(now).format('YYYY-MM-DD HH:mm:ss'),
            export_timestamp: Math.round(now.valueOf() / 1000),
            export_app: 'com.lgou2w.hoyo.gacha',
            export_app_version: 'v0.4.0',
            srgf_version: 'v1.0',
            region_time_zone: 8
          },
          list: []
        };

        const list = [];
        for (const item of account.list) {
          const dict = DICT[item.item_id];
          if (!dict) {
            throw new Error(`字典缺失物品 ID 条目：${item.item_id}`);
          }

          list.push({
            id: item.id,
            uid,
            gacha_id: item.gacha_id,
            gacha_type: item.gacha_type,
            item_id: item.item_id || dict.item_id,
            count: item.count || '1',
            time: item.time,
            name: item.name || dict.name,
            lang: 'zh-cn',
            item_type: item.item_type || dict.item_type,
            rank_type: item.rank_type || dict.rank_type
          });
        }

        uigf.list = list;

        const output = JSON.stringify(uigf);
        const blob = new Blob([output], { type: 'application/json;charset=utf-8' });

        const datetime = dayjs(now).format('YYYYMMDD_HHmmss');
        saveAs(blob, `SRGF_v1_0_${uid}_${datetime}.json`);
      }
    }
  </script>
</body>
</html>
